<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚µã‚¦ãƒ³ãƒ‰è¦³å¯Ÿãƒ©ãƒœ</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#f7f8ff; --bg2:#e6e9ff; --card:#ffffffdd;
  --ink:#334; --accent:#ff7eb6; --accent2:#7ec8ff; --grid:#ccd3ff;
}
*{box-sizing:border-box;}
body{margin:0;font-family:"M PLUS Rounded 1c",sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);}
header{padding:12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;}
button,select,input[type=color]{border:none;border-radius:20px;padding:8px 14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-weight:700;cursor:pointer;}
.card{margin:12px;background:var(--card);border-radius:20px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);}
canvas{width:100%;height:480px;border-radius:16px;background:linear-gradient(#ffffff,#eef1ff);}
#snapshots{margin:10px;font-size:13px;}
.phaseCtrl{display:flex;align-items:center;gap:6px;margin:4px 0;}
.deleteBtn{cursor:pointer;color:#c33;font-weight:bold;}
</style>
</head>
<body>

<header>
  <div>
    <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="stopBtn">ã‚¹ãƒˆãƒƒãƒ—</button>
    <button id="snapBtn">ğŸ“·</button>
    <input type="color" id="colorPicker" value="#ff7eb6">
    <button id="clearColor">é€æ˜</button>
  </div>

  <div>
    <span>è¡¨ç¤ºï¼š</span>
    <select id="modeSel">
      <option value="wave">æ™‚é–“æ³¢å½¢</option>
      <option value="polar">æ¥µåº§æ¨™</option>
      <option value="lissajous">ãƒªã‚µãƒ¼ã‚¸ãƒ¥</option>
      <option value="spectrum">ã‚¹ãƒšã‚¯ãƒˆãƒ«</option>
    </select>
  </div>
</header>

<div class="card">
  <canvas id="cv"></canvas>
</div>

<div id="snapshots"></div>

<script>
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
let audioCtx, analyser, dataTime, dataFreq, stream;
let snapshots=[];
let currentColor="#ff7eb6";

colorPicker.oninput=e=>currentColor=e.target.value;
clearColor.onclick=()=>currentColor="transparent";

function resize(){
  const dpr=window.devicePixelRatio||1;
  cv.width=cv.clientWidth*dpr;
  cv.height=cv.clientHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.onresize=resize; resize();

async function start(){
  audioCtx=new AudioContext();
  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const src=audioCtx.createMediaStreamSource(stream);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=2048;
  src.connect(analyser);
  dataTime=new Uint8Array(analyser.fftSize);
  dataFreq=new Uint8Array(analyser.frequencyBinCount);
  draw();
}
function stop(){stream.getTracks().forEach(t=>t.stop());audioCtx.close();}
startBtn.onclick=start; stopBtn.onclick=stop;

snapBtn.onclick=()=>{
  analyser.getByteTimeDomainData(dataTime);
  analyser.getByteFrequencyData(dataFreq);
  snapshots.push({time:new Uint8Array(dataTime),freq:new Uint8Array(dataFreq),color:currentColor,shift:0});
  updateSnapshotUI();
};

modeSel.onchange=updateSnapshotUI;

function updateSnapshotUI(){
  const box=document.getElementById("snapshots");
  box.innerHTML="<b>ä¿å­˜ã—ãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼š</b>";
  const mode=modeSel.value;

  snapshots.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="phaseCtrl";
    div.innerHTML=`<span style="color:${s.color}">â– </span> #${i+1}`;

    if(mode==="wave"){
      const slider=document.createElement("input");
      slider.type="range"; slider.min=-1024; slider.max=1024; slider.value=s.shift;
      slider.oninput=e=>s.shift=parseInt(e.target.value);
      div.appendChild(document.createTextNode(" ä½ç›¸"));
      div.appendChild(slider);
    }

    const del=document.createElement("span");
    del.textContent=" âŒ";
    del.className="deleteBtn";
    del.onclick=()=>{snapshots.splice(i,1);updateSnapshotUI();}
    div.appendChild(del);
    box.appendChild(div);
  });
}

function draw(){
  requestAnimationFrame(draw);
  if(!analyser)return;
  analyser.getByteTimeDomainData(dataTime);
  analyser.getByteFrequencyData(dataFreq);

  const fullW=cv.width/(window.devicePixelRatio||1);
  const fullH=cv.height/(window.devicePixelRatio||1);
  ctx.clearRect(0,0,fullW,fullH);

  const mode=modeSel.value;

  // ===== å¤–å´ãƒ©ãƒ™ãƒ«ç”¨ãƒãƒ¼ã‚¸ãƒ³ =====
  const margin={left:70,right:20,top:30,bottom:50};
  const w=fullW-margin.left-margin.right;
  const h=fullH-margin.top-margin.bottom;

  ctx.save();
  ctx.translate(margin.left,margin.top);

  ctx.strokeStyle="#e4e8ff";
  ctx.fillStyle="#445";
  ctx.font="12px 'M PLUS Rounded 1c'";

  // ===== ç›®ç›› =====
  if(mode==="wave"){
    const duration=dataTime.length/audioCtx.sampleRate*1000;
    for(let i=0;i<=10;i++){
      let x=i*w/10;
      ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();
      ctx.fillText(Math.round(i*duration/10),x-10,h+15);
    }
    for(let j=0;j<=8;j++){
      let y=j*h/8;
      ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();
      ctx.fillText(((1-j/8)*2-1).toFixed(1),-45,y+4);
    }
  }

  if(mode==="spectrum"){
    const nyq=audioCtx.sampleRate/2;
    for(let i=0;i<=10;i++){
      let x=i*w/10;
      ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();
      ctx.fillText(Math.round(i*nyq/10),x-10,h+15);
    }
    for(let j=0;j<=8;j++){
      let y=j*h/8;
      ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();
      ctx.fillText((100-j*12.5).toFixed(0),-45,y+4);
    }
  }

  if(mode==="lissajous"){
    for(let i=0;i<=8;i++){
      let x=i*w/8;
      ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();
      ctx.fillText((i/8*2-1).toFixed(1),x-10,h+15);
    }
    for(let j=0;j<=8;j++){
      let y=j*h/8;
      ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();
      ctx.fillText(((1-j/8)*2-1).toFixed(1),-45,y+4);
    }
  }

  if(mode==="polar"){
    const cx=w/2,cy=h/2,R=Math.min(w,h)*0.35;
    for(let r=0.25;r<=1;r+=0.25){
      ctx.beginPath();ctx.arc(cx,cy,R*r,0,Math.PI*2);ctx.stroke();
      ctx.fillText(r.toFixed(2),cx+5,cy-R*r);
    }
    for(let a=0;a<360;a+=30){
      let rad=a*Math.PI/180;
      ctx.beginPath();ctx.moveTo(cx,cy);
      ctx.lineTo(cx+Math.cos(rad)*R,cy+Math.sin(rad)*R);ctx.stroke();
      ctx.fillText(a+"Â°",cx+Math.cos(rad)*(R+12),cy+Math.sin(rad)*(R+12));
    }
  }

  // ===== ã‚°ãƒ©ãƒ•æç”» =====
  function wave(arr,color,shift=0){
    if(color==="transparent")return;
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let idx=(i+shift+arr.length)%arr.length;
      let x=i*w/arr.length;
      let y=h/2+(arr[idx]-128)/128*h*0.4;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    } ctx.stroke();
  }
  function polar(arr,color){
    if(color==="transparent")return;
    const cx=w/2,cy=h/2,R=Math.min(w,h)*0.35;
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let ang=i/arr.length*Math.PI*2;
      let amp=(arr[i]-128)/128;
      let r=R*(0.6+amp*0.4);
      let x=cx+Math.cos(ang)*r,y=cy+Math.sin(ang)*r;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    }
    ctx.closePath(); ctx.stroke();
  }
  function liss(arr,color){
    if(color==="transparent")return;
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let x=(arr[i]-128)/128;
      let y=(arr[(i+100)%arr.length]-128)/128;
      x=w/2+x*w*0.4; y=h/2+y*h*0.4;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    }
    ctx.stroke();
  }
  function spectrum(arr,color){
    if(color==="transparent")return;
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let x=i*w/arr.length;
      let y=h-arr[i]/255*h*0.9;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    }
    ctx.stroke();
  }

  snapshots.forEach(s=>{
    if(mode==="wave") wave(s.time,s.color,s.shift);
    if(mode==="polar") polar(s.time,s.color);
    if(mode==="lissajous") liss(s.time,s.color);
    if(mode==="spectrum") spectrum(s.freq,s.color);
  });

  if(mode==="wave") wave(dataTime,currentColor);
  if(mode==="polar") polar(dataTime,currentColor);
  if(mode==="lissajous") liss(dataTime,currentColor);
  if(mode==="spectrum") spectrum(dataFreq,currentColor);

  ctx.restore();

  // ===== è»¸ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå¤–å´ï¼‰ =====
  ctx.fillStyle="#334";
  ctx.font="14px 'M PLUS Rounded 1c'";
  if(mode==="wave"){
    ctx.fillText("æ™‚é–“ (ms)", fullW/2-35, fullH-10);
    ctx.save();ctx.rotate(-Math.PI/2);
    ctx.fillText("æŒ¯å¹…", -fullH/2, 20);
    ctx.restore();
  }
  if(mode==="spectrum"){
    ctx.fillText("å‘¨æ³¢æ•° (Hz)", fullW/2-40, fullH-10);
    ctx.save();ctx.rotate(-Math.PI/2);
    ctx.fillText("å¼·åº¦ (%)", -fullH/2, 20);
    ctx.restore();
  }
  if(mode==="lissajous"){
    ctx.fillText("XæŒ¯å¹…", fullW/2-20, fullH-10);
    ctx.save();ctx.rotate(-Math.PI/2);
    ctx.fillText("YæŒ¯å¹…", -fullH/2, 20);
    ctx.restore();
  }
  if(mode==="polar"){
    ctx.fillText("è§’åº¦ (Â°)", fullW/2-25, 20);
    ctx.fillText("åŠå¾„ã‚¹ã‚±ãƒ¼ãƒ«", fullW-130, fullH/2);
  }
}
</script>
</body>
</html>
