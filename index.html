<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>„Çµ„Ç¶„É≥„ÉâË¶≥ÂØü„É©„Éú</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#f7f8ff; --bg2:#e6e9ff; --card:#ffffffdd;
  --ink:#334; --accent:#ff7eb6; --accent2:#7ec8ff; --grid:#ccd3ff;
}
*{box-sizing:border-box;}
body{margin:0;font-family:"M PLUS Rounded 1c",sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);}
header{padding:12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;}
button,select,input[type=color]{border:none;border-radius:20px;padding:8px 14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-weight:700;cursor:pointer;}
.card{margin:12px;background:var(--card);border-radius:20px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);}
canvas{width:100%;height:480px;border-radius:16px;background:linear-gradient(#ffffff,#eef1ff);}
.label{font-size:14px;margin-right:6px;}
#snapshots{margin:10px;font-size:13px;}
.phaseCtrl{display:flex;align-items:center;gap:6px;margin:4px 0;}
</style>
</head>
<body>

<header>
  <div>
    <button id="startBtn">„Çπ„Çø„Éº„Éà</button>
    <button id="stopBtn">„Çπ„Éà„ÉÉ„Éó</button>
    <button id="snapBtn">üì∑</button>
    <input type="color" id="colorPicker" value="#ff7eb6">
  </div>
  <div>
    <span class="label">Ë°®Á§∫Ôºö</span>
    <select id="modeSel">
      <option value="wave">ÊôÇÈñìÊ≥¢ÂΩ¢</option>
      <option value="polar">Ê•µÂ∫ßÊ®ô</option>
      <option value="lissajous">„É™„Çµ„Éº„Ç∏„É•</option>
      <option value="spectrum">„Çπ„Éö„ÇØ„Éà„É´</option>
    </select>
  </div>
</header>

<div class="card">
  <canvas id="cv"></canvas>
</div>

<div id="snapshots"></div>

<script>
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
let audioCtx, analyser, dataTime, dataFreq, stream;
let snapshots=[];

function resize(){
  const dpr=window.devicePixelRatio||1;
  cv.width=cv.clientWidth*dpr;
  cv.height=cv.clientHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.onresize=resize; resize();

async function start(){
  audioCtx=new AudioContext();
  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const src=audioCtx.createMediaStreamSource(stream);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=2048;
  src.connect(analyser);
  dataTime=new Uint8Array(analyser.fftSize);
  dataFreq=new Uint8Array(analyser.frequencyBinCount);
  draw();
}
function stop(){stream.getTracks().forEach(t=>t.stop());audioCtx.close();}
startBtn.onclick=start; stopBtn.onclick=stop;

snapBtn.onclick=()=>{
  if(!dataTime) return;
  analyser.getByteTimeDomainData(dataTime);
  analyser.getByteFrequencyData(dataFreq);
  snapshots.push({
    time:new Uint8Array(dataTime),
    freq:new Uint8Array(dataFreq),
    color:colorPicker.value,
    shift:0
  });
  updateSnapshotUI();
};

function updateSnapshotUI(){
  const box=document.getElementById("snapshots");
  box.innerHTML="<b>‰øùÂ≠ò„Åó„Åü„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÔºö</b>";
  const mode=modeSel.value;
  snapshots.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="phaseCtrl";
    div.innerHTML=`<span style="color:${s.color}">‚ñ†</span> #${i+1}`;
    if(mode==="wave"){
      const slider=document.createElement("input");
      slider.type="range"; slider.min=-1024; slider.max=1024; slider.value=s.shift;
      slider.oninput=e=>s.shift=parseInt(e.target.value);
      div.appendChild(document.createTextNode(" ‰ΩçÁõ∏"));
      div.appendChild(slider);
    }
    box.appendChild(div);
  });
}

modeSel.onchange=updateSnapshotUI;

function drawAxes(){
  const w=cv.width/(window.devicePixelRatio||1);
  const h=cv.height/(window.devicePixelRatio||1);
  ctx.strokeStyle="#ccd3ff"; ctx.lineWidth=1;
  for(let i=0;i<=10;i++){let x=i*w/10; ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(let j=0;j<=8;j++){let y=j*h/8; ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
}

function draw(){
  requestAnimationFrame(draw);
  if(!analyser)return;
  analyser.getByteTimeDomainData(dataTime);
  analyser.getByteFrequencyData(dataFreq);
  ctx.clearRect(0,0,cv.width,cv.height);
  const w=cv.width/(window.devicePixelRatio||1);
  const h=cv.height/(window.devicePixelRatio||1);
  drawAxes();

  const mode=modeSel.value;

  function drawWave(arr,color,shift=0){
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let idx=(i+shift+arr.length)%arr.length;
      let x=i*w/arr.length;
      let y=h/2+(arr[idx]-128)/128*h*0.4;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    } ctx.stroke();
  }

  function drawPolar(arr,color){
    const cx=w/2,cy=h/2,R=Math.min(w,h)*0.35;
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let ang=i/arr.length*Math.PI*2;
      let amp=(arr[i]-128)/128;
      let r=R*(0.6+amp*0.4);
      let x=cx+Math.cos(ang)*r,y=cy+Math.sin(ang)*r;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    } ctx.closePath(); ctx.stroke();
  }

  function drawLissajous(arr,color){
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let x=(arr[i]-128)/128;
      let y=(arr[(i+100)%arr.length]-128)/128;
      x=w/2+x*w*0.4; y=h/2+y*h*0.4;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    } ctx.stroke();
  }

  function drawSpectrum(arr,color){
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let x=i*w/arr.length;
      let y=h-arr[i]/255*h*0.9;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    } ctx.stroke();
  }

  snapshots.forEach(s=>{
    if(mode==="wave") drawWave(s.time,s.color,s.shift);
    else if(mode==="polar") drawPolar(s.time,s.color);
    else if(mode==="lissajous") drawLissajous(s.time,s.color);
    else if(mode==="spectrum") drawSpectrum(s.freq,s.color);
  });

  if(mode==="wave") drawWave(dataTime,colorPicker.value);
  else if(mode==="polar") drawPolar(dataTime,colorPicker.value);
  else if(mode==="lissajous") drawLissajous(dataTime,colorPicker.value);
  else if(mode==="spectrum") drawSpectrum(dataFreq,colorPicker.value);
}
</script>
</body>
</html>
