<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚µã‚¦ãƒ³ãƒ‰è¦³å¯Ÿãƒ©ãƒœ</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#f7f8ff; --bg2:#e6e9ff; --card:#ffffffdd;
  --ink:#334; --accent:#ff7eb6; --accent2:#7ec8ff; --grid:#ccd3ff;
}
*{box-sizing:border-box;}
body{margin:0;font-family:"M PLUS Rounded 1c",sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);}
header{padding:12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;}
button,select,input[type=color]{border:none;border-radius:20px;padding:8px 14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-weight:700;cursor:pointer;}
.card{margin:12px;background:var(--card);border-radius:20px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);}
canvas{width:100%;height:480px;border-radius:16px;background:linear-gradient(#ffffff,#eef1ff);}
.label{font-size:14px;margin-right:6px;}
#snapshots{margin:10px;font-size:13px;}
.phaseCtrl{display:flex;align-items:center;gap:6px;margin:4px 0;}
</style>
</head>
<body>

<header>
  <div>
    <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="stopBtn">ã‚¹ãƒˆãƒƒãƒ—</button>
    <button id="snapBtn">ğŸ“·</button>
    <input type="color" id="colorPicker" value="#ff7eb6">
  </div>
  <div>
    <span class="label">è¡¨ç¤ºï¼š</span>
    <select id="modeSel">
      <option value="wave">æ™‚é–“æ³¢å½¢</option>
      <option value="polar">æ¥µåº§æ¨™</option>
      <option value="lissajous">ãƒªã‚µãƒ¼ã‚¸ãƒ¥</option>
      <option value="spectrum">ã‚¹ãƒšã‚¯ãƒˆãƒ«</option>
    </select>
  </div>
</header>

<div class="card">
  <canvas id="cv"></canvas>
</div>

<div id="snapshots"></div>

<script>
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
let audioCtx, analyser, dataTime, stream;
let snapshots=[];

function resize(){
  const dpr=window.devicePixelRatio||1;
  cv.width=cv.clientWidth*dpr;
  cv.height=cv.clientHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.onresize=resize; resize();

async function start(){
  audioCtx=new AudioContext();
  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const src=audioCtx.createMediaStreamSource(stream);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=2048;
  src.connect(analyser);
  dataTime=new Uint8Array(analyser.fftSize);
  draw();
}
function stop(){stream.getTracks().forEach(t=>t.stop());audioCtx.close();}
startBtn.onclick=start; stopBtn.onclick=stop;

snapBtn.onclick=()=>{
  if(!dataTime) return;
  snapshots.push({data:new Uint8Array(dataTime), color:colorPicker.value, shift:0});
  updateSnapshotUI();
};

function updateSnapshotUI(){
  const box=document.getElementById("snapshots");
  box.innerHTML="<b>ä¿å­˜ã—ãŸæ³¢å½¢ï¼š</b>";
  snapshots.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="phaseCtrl";
    div.innerHTML=`<span style="color:${s.color}">â– </span> #${i+1} ä½ç›¸`;
    const slider=document.createElement("input");
    slider.type="range"; slider.min=-1024; slider.max=1024; slider.value=0;
    slider.oninput=e=>s.shift=parseInt(e.target.value);
    div.appendChild(slider);
    box.appendChild(div);
  });
}

function drawAxes(){
  const w=cv.width/(window.devicePixelRatio||1);
  const h=cv.height/(window.devicePixelRatio||1);
  ctx.strokeStyle="#ccd3ff"; ctx.lineWidth=1;
  for(let i=0;i<=10;i++){let x=i*w/10; ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(let j=0;j<=8;j++){let y=j*h/8; ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
}

function draw(){
  requestAnimationFrame(draw);
  if(!analyser)return;
  analyser.getByteTimeDomainData(dataTime);
  ctx.clearRect(0,0,cv.width,cv.height);
  const w=cv.width/(window.devicePixelRatio||1);
  const h=cv.height/(window.devicePixelRatio||1);
  drawAxes();

  function drawWave(arr,color,shift=0){
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
    for(let i=0;i<arr.length;i++){
      let idx=(i+shift+arr.length)%arr.length;
      let x=i*w/arr.length;
      let y=h/2+(arr[idx]-128)/128*h*0.4;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    } ctx.stroke();
  }

  snapshots.forEach(s=>drawWave(s.data,s.color,s.shift));
  drawWave(dataTime,colorPicker.value,0);
}
</script>
</body>
</html>
